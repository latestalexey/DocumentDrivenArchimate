<!DOCTYPE html>
<html ng-app="app">
<head>
  <meta charset="utf-8">
  <title>d3js_archimate</title>
  <link rel="stylesheet" href="app.css">


  <script src="angular.min.js"></script>
  <script src="http://localhost/DocumentDrivenArchimate/bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
  <link rel="import" href="http://localhost/DocumentDrivenArchimate/bower_components/paper-tabs/paper-tabs.html" />
  <!-- icons -->
  <link rel="import" href="http://localhost/DocumentDrivenArchimate/bower_components/iron-icons/iron-icons.html">
  <!--<link rel="import" href="http://localhost/DocumentDrivenArchimate/bower_components/iron-icons/maps-icons.html">
  <link rel="import" href="http://localhost/DocumentDrivenArchimate/bower_components/iron-iconset-svg/iron-iconset-svg.html">-->
  <link rel="import" href="http://localhost/DocumentDrivenArchimate/bower_components/iron-pages/iron-pages.html" />

  <link rel="import" href="http://localhost/DocumentDrivenArchimate/bower_components/paper-toast/paper-toast.html" />

  <link rel="import" href="http://localhost/DocumentDrivenArchimate/bower_components/iron-flex-layout/classes/iron-flex-layout.html" />

  <link rel="import" href="http://localhost/DocumentDrivenArchimate/bower_components/paper-toolbar/paper-toolbar.html" />
  <link rel="import" href="http://localhost/DocumentDrivenArchimate/bower_components/paper-menu/paper-menu.html" />
  <link rel="import" href="http://localhost/DocumentDrivenArchimate/bower_components/paper-icon-button/paper-icon-button.html" />
  <link rel="import" href="http://localhost/DocumentDrivenArchimate/bower_components/paper-listbox/paper-listbox.html" />
  <link rel="import" href="http://localhost/DocumentDrivenArchimate/bower_components/paper-input/paper-input.html" />
  <link rel="import" href="http://localhost/DocumentDrivenArchimate/theme/classical/classical.html" />

  <!-- use paper-toast to indicate that saves wont be saved -->

  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="resources/archimate_configuration.js"></script>
  <script src="documentmodengine.js"></script>

  <script>
  //prepare('http://localhost/Archisurance.xml',"de");
  prepare('http://localhost/Reference%20Model.xml','en');

  angular.module('app', [])
  .controller('createTabs', ['$scope', function createTabs($scope) {
    $scope.tabs = [{id:"div0"},{id:"div1"}];
  }])
  .controller('createPages', ['$scope', function createPages($scope) {
    $scope.pages = [];
  }]);

  function updateMenu(){
    if(window.done){

      for(var i=0;i < window.viewsdata.children().size();i++){
        var tab = {};
        tab.tabtext = $(window.viewsdata.children().eq(i)).children('label[xml\\:lang="'+functions.usersettings.lang+'"]').text();
        tab.divid = "div"+i;
        tab.content = window.viewvisualisations[i]
        //t.stuff.push(tab);
        if(!menu.stuff){
          menu.stuff = [];
        }
        menu.stuff = menu.stuff.concat(tab);
      }

    }else{
      setTimeout(updateMenu,100);
    }
  }

  </script>


</head>

<body ng-model="selected" onload="updateMenu()">
<paper-toast text="Warning! You have not checked out the Model. Changes won't be saved." opened></paper-toast>
<!--<paper-menu>
    <paper-item>Item 1</paper-item>
    <paper-item>Item 2</paper-item>
  </paper-menu>-->

<dom-module id="model-menu">
  <template>

  <paper-toolbar class="medium-tall">
    <paper-icon-button icon="menu"></paper-icon-button>
    <span class="title">Document Driven Archimate</span>
    <!--<paper-icon-button icon="refresh"></paper-icon-button>
    <paper-icon-button icon="add">+</paper-icon-button>-->

      <paper-tabs id="menuTabs" class="middle" selected="{{selected}}" style="width:100%" scrollable>
        <template is="dom-repeat" items="{{stuff}}">
          <paper-tab on-click="refreshSvg">{{item.tabtext}}</paper-tab>
        </template>
      </paper-tabs>
  </paper-toolbar>

      <iron-pages id="menuPages" selected="{{selected}}">
        <template is="dom-repeat" items="{{stuff}}">
          <div id="{{item.divid}}" style="overflow:auto"></div>
        </template>
      </iron-pages>
    </template>
    <script>
    Polymer({
      is: 'model-menu',
      properties: {
        stuff: Array,
        selected:Number

      },
      refreshSvg : function(){
        for(var i = 0; i < window.viewvisualisations.length;i++){
          d3.select("div#div"+i)[0][0].appendChild(window.viewvisualisations[i]);
          d3.select("div#div"+i).style("padding","5px");

          var rect = d3.select("div#div"+i).select("svg")[0][0].getBBox();

          //var maxwidth = Math.max(d3.select("div#div"+i)[0][0].getBoundingClientRect().width,rect.width);
          //var maxheight = Math.max(d3.select("div#div"+i)[0][0].getBoundingClientRect().height,rect.height);


          d3.select("div#div"+i).select("svg").attr("width",rect.width*1.05);
          d3.select("div#div"+i).select("svg").attr("height",rect.height*1.05);
          d3.select("div#div"+i).select("svg").attr("viewBox",rect.x+","+rect.y+","+rect.height*1.05+","+rect.width*1.05);

          //d3.select("div#div"+i).style("width",(maxwidth*1.05)+"px");
          d3.select("div#div"+i).style("width","100%");
          //d3.select("div#div"+i).style("height",(maxheight*1.05)+"px");

          d3.select("div#div"+i).style("height",($(window).height()-300)+"px");
        }
      }
      });
      /*menu = document.querySelector('#menu');
      menu.stuff=[];*/

      //Polymer.RenderStatus.afterNextRender(menu,refreshSvg)
      //document.addEventListener('iron-select', refreshSvg);
    </script>

</dom-module>
<model-menu id="menu"></model-menu>
<!-- start: custom elements -->
<dom-module id="model-reference">
  <template>
    <div class="layout horizontal">
      <div class="flex">
      <paper-input label="[[label]]" disabled$="[[disabled]]" value="[[link]]"></paper-input>
    </div><div><paper-icon-button icon="reply" title="reply"></paper-icon-button></div>
    </div>
  </template>
  <script>
    Polymer({
      is: 'model-reference',
      properties: {
        label: String,
        link: String,
        disabled: Boolean
      }
    });
  </script>
</dom-module>

<dom-module id="model-zoom">
  <template>
    <div class="layout horizontal">
      <div class="flex">
      </div>
      <div>
      <paper-icon-button icon="add-box" title="add" on-click="zoomin"></paper-icon-button>
    </div>
    <div>
      <paper-icon-button icon="indeterminate-check-box" title="remove" on-click="zoomout"></paper-icon-button>
    </div>
    </div>
  </template>
  <script>
    Polymer({
      is: 'model-zoom',
      properties: {
        label: String,
        link: String,
        disabled: Boolean
      },
      zoomin: function(e){
        var svg = d3.select("div.iron-selected").select("svg");
        svg.attr("width",parseFloat(svg.attr("width"))*1.5);
        svg.attr("height",parseFloat(svg.attr("height"))*1.5);
      },
      zoomout: function(e){
        var svg = d3.select("div.iron-selected").select("svg");
        svg.attr("width",parseFloat(svg.attr("width"))/1.5);
        svg.attr("height",parseFloat(svg.attr("height"))/1.5);
      }
    });
  </script>
</dom-module>
<model-zoom></model-zoom>
<!-- end: custom elements -->
<paper-listbox vertical-align="bottom" style="height:100%;padding-left:5%;padding-right:5%">

  <model-reference label="direct links" link="test.zip" disabled></model-reference>
  <model-reference label="indirect links of subordinated" link="test.zip" disabled></model-reference>
  <model-reference label="enable multiselect" link="test.zip" disabled></model-reference>

</paper-listbox>

</body>


</html>
